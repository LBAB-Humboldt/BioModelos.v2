$(document).ready(function(){
	validate.validators.presence.message = "no puede estar vacío";

	// Validación de los campos editables de un registro.
	var latNewRecord = $("#txtNewRecordLat").val(),
		lonNewRecord = $("#txtNewRecordLon").val(),
		altNewRecord = $("#r_altitude").val(),
		yearNewRecord = $("#year_registro").val(),
		monthNewRecord = $("#month_registro").val(),
		dayNewRecord = $("#day_registro").val(),
		depNewRecord = $("#r_departamento").val(),
		munNewRecord = $("#r_municipio").val(),
		locNewRecord = $("#r_localidad").val(),
		tipoNewRecord = $("#r_tipo").val(),
		colNewRecord = $("#r_observador").val(),
		commentNewRecord = $("#r_comment").val();


	var varsToValidate = {},
	constraints = {},
	data = {userId_bm: <%= current_user.id %>,
			taxID: $("#species_id_field").val()};
	
	varsToValidate.lat = latNewRecord;
	constraints.lat = {};
	constraints.lat.numericality = {};
	constraints.lat.presence = true;
	constraints.lat.numericality.greaterThanOrEqualTo = -90;
	constraints.lat.numericality.lessThanOrEqualTo = 90;
	data.lat = latNewRecord;

	varsToValidate.lon = lonNewRecord;
	constraints.lon = {};
	constraints.lon.numericality = {};
	constraints.lon.presence = true;
	constraints.lon.numericality.greaterThanOrEqualTo = -180;
	constraints.lon.numericality.lessThanOrEqualTo = 180;
	data.lon = lonNewRecord;

	varsToValidate.localidad = locNewRecord;
	constraints.localidad = {};
	constraints.localidad.presence = true;
	data.locality = locNewRecord;

	if(altNewRecord != ""){
		varsToValidate.altura = altNewRecord;
		constraints.altura = {};
		constraints.altura.numericality = {};
		constraints.altura.numericality.greaterThanOrEqualTo = 0;
		constraints.altura.numericality.lessThanOrEqualTo = 10000;
		data["alt"] = altNewRecord;
	}

	if(yearNewRecord != ""){
		varsToValidate.yyyy = yearNewRecord;
		constraints.yyyy = {};
		constraints.yyyy.numericality = {};
		constraints.yyyy.numericality.greaterThanOrEqualTo = 1800;
		constraints.yyyy.numericality.lessThanOrEqualTo = moment.utc().year();
		data.yyyy = yearNewRecord;
	}
	if(monthNewRecord != ""){
		varsToValidate.mm = monthNewRecord;
		constraints.mm = {};
		constraints.mm.numericality = {};
		constraints.mm.numericality.greaterThanOrEqualTo = 1;
		constraints.mm.numericality.lessThanOrEqualTo = 12;
		data.mm = monthNewRecord;
	}
	if(dayNewRecord != ""){
		varsToValidate.dd = dayNewRecord;
		constraints.dd = {};
		constraints.dd.numericality = {};
		constraints.dd.numericality.greaterThanOrEqualTo = 1;
		constraints.dd.numericality.lessThanOrEqualTo = 31;
		data.dd = dayNewRecord;
	}
	if(depNewRecord != "")
		data.adm1 = depNewRecord;
	if(munNewRecord != "")
		data.adm2 = munNewRecord;
	if(tipoNewRecord != "")
		data.basisOfRecord = tipoNewRecord;
	if(colNewRecord != "")
		data.collector = colNewRecord;
	if(commentNewRecord != "")
		data.citation_bm = commentNewRecord;

	var valResponse = validate(varsToValidate, constraints, {format: "flat"});
	console.log(valResponse);
	if(valResponse){
		var response = "";
		for(var i=0; i<valResponse.length; i++){
			response += valResponse[i] + "\n";
		}
		alertify.alert(response);
	}
	else{
		console.log("Sin respuesta");
		console.log(data);
		$.ajax({
		    type: 'POST',
		    dataType: 'json',
		    url: "http://192.168.11.81:3000/BioModelos/records/",
		    data: data,
		    success: function(){
		    	_BioModelosVisorModule.cancelAddPoint();
				_BioModelosVisorModule.getSpeciesRecords("<%= BASE_URI %>/records/" + $("#species_id_field").val());
				alertify.alert("El registro ha sido agregado con éxito");
			},
			error: function(jqXHR, textStatus, errorThrown){
				alertify.alert("Ha ocurrido un error al agregar el registro: " + textStatus);
			}
		});
	}
});